{
  "version": 3,
  "sources": ["../../../../../../../Users/leyla/ReadyAI2/netlify/functions/submit-lead.ts", "../../../../../../../Users/leyla/ReadyAI2/netlify/functions/lib/eway-crm.ts"],
  "sourceRoot": "/private/var/folders/h7/s507g24n2h350_w6nw1tkym00000gn/T/tmp-39266-dOraVHRQ19iU",
  "sourcesContent": ["/**\n * Netlify Function: Submit Lead to eWay CRM\n * Endpoint: /.netlify/functions/submit-lead\n */\n\nimport { Handler, HandlerEvent } from '@netlify/functions';\nimport { EwayCRMClient } from './lib/eway-crm';\n\ninterface LeadData {\n  firstName: string;\n  lastName: string;\n  email: string;\n  source?: string;\n  consent?: boolean;\n}\n\n/**\n * Validate email format\n */\nfunction isValidEmail(email: string): boolean {\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email);\n}\n\n/**\n * Validate lead data\n */\nfunction validateLeadData(data: any): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n\n  if (!data.firstName || data.firstName.trim().length === 0) {\n    errors.push('First name is required');\n  }\n\n  if (!data.lastName || data.lastName.trim().length === 0) {\n    errors.push('Last name is required');\n  }\n\n  if (!data.email || !isValidEmail(data.email)) {\n    errors.push('Valid email is required');\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n  };\n}\n\n/**\n * Main handler function\n */\nexport const handler: Handler = async (event: HandlerEvent) => {\n  // Only allow POST requests\n  if (event.httpMethod !== 'POST') {\n    return {\n      statusCode: 405,\n      body: JSON.stringify({ error: 'Method not allowed' }),\n    };\n  }\n\n  try {\n    // Parse request body\n    const leadData: LeadData = JSON.parse(event.body || '{}');\n\n    console.log('Received lead submission:', {\n      email: leadData.email,\n      source: leadData.source,\n      timestamp: new Date().toISOString(),\n    });\n\n    // Validate data\n    const validation = validateLeadData(leadData);\n    if (!validation.valid) {\n      return {\n        statusCode: 400,\n        body: JSON.stringify({\n          success: false,\n          errors: validation.errors,\n        }),\n      };\n    }\n\n    // Check for test mode (won't send to eWay CRM)\n    if (process.env.EWAY_TEST_MODE === 'true') {\n      console.log('[TEST MODE] Would send to eWay CRM:', leadData);\n      return {\n        statusCode: 200,\n        body: JSON.stringify({\n          success: true,\n          testMode: true,\n          message: 'Test mode - no data sent to eWay CRM',\n        }),\n      };\n    }\n\n    // Get eWay CRM credentials from environment\n    const ewayUsername = process.env.EWAY_CRM_USERNAME;\n    const ewayPassword = process.env.EWAY_CRM_PASSWORD;\n    const ewayServiceUrl = process.env.EWAY_CRM_SERVICE_URL;\n\n    if (!ewayUsername || !ewayPassword || !ewayServiceUrl) {\n      console.error('Missing eWay CRM credentials in environment variables');\n      return {\n        statusCode: 500,\n        body: JSON.stringify({\n          success: false,\n          error: 'Server configuration error',\n        }),\n      };\n    }\n\n    // Initialize eWay CRM client\n    const ewayClient = new EwayCRMClient({\n      username: ewayUsername,\n      password: ewayPassword,\n      serviceUrl: ewayServiceUrl,\n    });\n\n    // Create contact in eWay CRM\n    const result = await ewayClient.createContact({\n      FirstName: leadData.firstName,\n      LastName: leadData.lastName,\n      Email: leadData.email,\n      Category: leadData.source || 'Website Lead',\n      AdditionalFields: {\n        Description: leadData.consent\n          ? 'User consented to privacy policy'\n          : undefined,\n      },\n    });\n\n    // Cleanup session\n    await ewayClient.logout();\n\n    console.log('Successfully created contact in eWay CRM:', {\n      email: leadData.email,\n      result: result,\n    });\n\n    return {\n      statusCode: 200,\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        success: true,\n        message: 'Lead submitted successfully',\n      }),\n    };\n  } catch (error) {\n    console.error('Error submitting lead:', error);\n\n    // Don't expose internal errors to client\n    return {\n      statusCode: 500,\n      body: JSON.stringify({\n        success: false,\n        error: 'Failed to submit lead. Please try again.',\n      }),\n    };\n  }\n};\n\n", "/**\n * eWay CRM API Client\n * Simple wrapper for eWay CRM REST API\n */\n\nimport { createHash } from 'crypto';\n\ninterface EwayContact {\n  FirstName: string;\n  LastName: string;\n  Email: string;\n  FileAs?: string;\n  Category?: string;\n  AdditionalFields?: Record<string, any>;\n}\n\ninterface EwayCredentials {\n  username: string;\n  password: string;\n  serviceUrl: string;\n}\n\nexport class EwayCRMClient {\n  private credentials: EwayCredentials;\n  private sessionId: string | null = null;\n\n  constructor(credentials: EwayCredentials) {\n    this.credentials = credentials;\n  }\n\n  /**\n   * Get Basic Auth header\n   */\n  private getAuthHeader(): string {\n    const authString = Buffer.from(\n      `${this.credentials.username}:${this.credentials.password}`\n    ).toString('base64');\n    return `Basic ${authString}`;\n  }\n\n  /**\n   * Create MD5 hash of password for API authentication\n   */\n  private hashPassword(password: string): string {\n    return createHash('md5').update(password).digest('hex');\n  }\n\n  /**\n   * Login to eWay CRM and get session ID\n   * Uses WCF API: POST to /LogIn\n   */\n  private async login(): Promise<string> {\n    console.log('Logging in to eWay CRM...');\n    console.log('Using service URL:', this.credentials.serviceUrl);\n    \n    const response = await fetch(`${this.credentials.serviceUrl}/LogIn`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json',\n      },\n      body: JSON.stringify({\n        userName: this.credentials.username,\n        passwordHash: this.hashPassword(this.credentials.password),\n        appVersion: 'ReadyAI1.0.0',\n        clientMachineIdentifier: 'netlify-function',\n        clientMachineName: 'ReadyAI-Website',\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('Login failed:', {\n        status: response.status,\n        statusText: response.statusText,\n        body: errorText,\n      });\n      throw new Error(`Login failed: ${response.statusText}`);\n    }\n\n    const result = await response.json();\n    console.log('Login successful:', result);\n    \n    // Extract SessionId from response (note: capital S)\n    if (result.SessionId) {\n      this.sessionId = result.SessionId;\n      return result.SessionId;\n    }\n    \n    throw new Error('No SessionId in login response');\n  }\n\n  /**\n   * Create a new contact in eWay CRM\n   * Uses WCF API: POST to /SaveContact\n   */\n  async createContact(contact: EwayContact): Promise<any> {\n    // Login if we don't have a session\n    if (!this.sessionId) {\n      await this.login();\n    }\n\n    // Prepare contact data according to eWay CRM WCF API format\n    const contactData = {\n      FirstName: contact.FirstName,\n      LastName: contact.LastName,\n      Email1Address: contact.Email, // Note: Email1Address, not Email\n      FileAs: contact.FileAs || `${contact.FirstName} ${contact.LastName}`,\n      Note: contact.AdditionalFields?.Description || '',\n      ...contact.AdditionalFields,\n    };\n\n    // WCF API expects: sessionId, transmitObject, dieOnItemConflict\n    const requestBody = {\n      sessionId: this.sessionId,\n      transmitObject: contactData,\n      dieOnItemConflict: false,\n    };\n\n    console.log('Sending to eWay CRM SaveContact:', {\n      url: `${this.credentials.serviceUrl}/SaveContact`,\n      sessionId: this.sessionId,\n      data: contactData,\n    });\n\n    const response = await fetch(`${this.credentials.serviceUrl}/SaveContact`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json',\n      },\n      body: JSON.stringify(requestBody),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('SaveContact error:', {\n        status: response.status,\n        statusText: response.statusText,\n        body: errorText,\n      });\n      throw new Error(`Failed to create contact: ${response.statusText}`);\n    }\n\n    const result = await response.json();\n    console.log('eWay CRM success:', result);\n    return result;\n  }\n\n  /**\n   * Logout and cleanup session\n   */\n  async logout(): Promise<void> {\n    if (!this.sessionId) return;\n\n    try {\n      await fetch(`${this.credentials.serviceUrl}/LogOut`, {\n        method: 'POST',\n        headers: {\n          'Authorization': this.getAuthHeader(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ sessionId: this.sessionId }),\n      });\n      console.log('Logged out successfully');\n    } catch (error) {\n      console.error('Logout error:', error);\n    } finally {\n      this.sessionId = null;\n    }\n  }\n}\n\n"],
  "mappings": "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",
  "names": []
}
